@using EduZone.Models
@using Microsoft.AspNet.Identity;
@using System.Linq;
@model List<PostInGroup>
@{
    ViewBag.Title = "Group_Post";
    ApplicationDbContext context = new ApplicationDbContext();
}
@section Top_Link{
    <link href="~/Content/StyleSheet/time-line-for-dector.css" rel="stylesheet" />
}
@Html.Partial("_GroupPartialView")


<div class="tab-content p-3 my-3">
    <div class="tab-pane active" id="Posts">
        @if (User.IsInRole("Educator"))
        {
            using (Html.BeginForm("AddPost", "Group", FormMethod.Post, new { @class = "mt-5" }))
            {
                <div class="timeline ">
                    <div class="photo-name">
                        <img class="photo-profile" src="~/Images/Femala.png" alt="">
                        <div class="info">
                            <h2 class="info-name">@User.Identity.Name</h2>
                        </div>
                    </div>
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="GrpCode" value=@ViewBag.GC />
                    <textarea class="m-3" name="ContentOfPost" id="ContentOfPost" placeholder="Write new announcement...">Title: </textarea>
                    <div class="line"></div>
                    <div class="like-comment live-photo">
                        <div>
                            <a href=""> <i class="fa-solid fa-photo-film"></i> </a>
                            <span class="text-secondary ms-2">Photo/video</span>
                        </div>
                        <button type="submit" class="btn btn-success ms-3"> POST </button>
                    </div>
                </div>
            }
        }
        <div id="here">

        </div>
        @foreach (var item in Model)
        {
            <div class="timeline">
                <div class="photo-name">
                    <img class="photo-profile" src="~/Images/Femala.png" alt="">
                    <div class="info">
                        <a href=""><h6 class="info-name">@item.UserName </h6></a>
                        <p class="info-date">@item.Date</p>
                    </div>
                </div>
                <pre class="news news-en">
                   @item.ContentOfPost
                </pre>
                <div class="line"></div>
                <div class="like-comment-p">
                    <div class="like-comment">
                        @if (context.LikeForPostInGroups.ToList().FirstOrDefault(id => id.UserID == User.Identity.GetUserId() && id.PostId == item.Id) != null)
                        {
                            <div>
                                <a data-user-id="@User.Identity.GetUserId()" data-item-id="@item.Id" onclick="funlike('@User.Identity.GetUserId()', @item.Id, true)">
                                    <i class="fa-solid fa-thumbs-up me-2 text-primary text-success" style="cursor: pointer;"></i>
                                </a>
                                <span class="text-secondary">Like</span>
                            </div>
                           
                        }
                        else
                        {
                            <div>
                                <a data-user-id="@User.Identity.GetUserId()" data-item-id="@item.Id" onclick="funlike('@User.Identity.GetUserId()', @item.Id, false)">
                                    <i class="fa-solid fa-thumbs-up me-2 text-secondary" style="cursor: pointer;"></i>
                                </a>
                                <span class="text-secondary">Like</span>
                            </div>
                        }

                    </div>
                    <div class="number-like-comment">
                        @{
                            int numcom = context.LikeForPostInGroups.Where(p => p.PostId == item.Id).Count();
                        }
                        <div><b>@numcom</b><span class="ms-2 text-secondary likes-span">Like</span> </div>
                    </div>
                </div>
            </div>
        }

        @section bottom_Link
        {
            <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
            <script src="~/Signalr/hubs"></script>
         
            <script>
                let proxy;
                $(function () {
                    var con = $.hubConnection();
                    proxy = con.createHubProxy("HubClass");
                    con.start();

                    // new post subscribtion
                    proxy.on("NewPostAddedInGroup", function (NewPost) {
                        window.alert('new post add');

                        let numid = NewPost.Id;

                        var con = `
                                    <div class="timeline" data-numid="${numid}">
                                    <div class="photo-name">
                                        <img class="photo-profile" src="/Images/Femala.png" alt="">
                                        <div class="info">
                                            <a href=""><h6 class="info-nm">     </h6></a>
                                            <p class="info-dt">    </p>
                                        </div>
                                    </div>
                                    <pre class="news news-en">

                                    </pre>
                                    <div class="line"></div>
                                    <div class="like-comment-p">
                                        <div class="like-comment">
                                            <div>
                                                <a data-user-id="@User.Identity.GetUserId()"  data-item-id="${numid}" onclick="funlike('@User.Identity.GetUserId()', $(this).closest('.timeline').data('numid'), false)">
                                                    <i class="fa-solid fa-thumbs-up me-2" style="cursor: pointer;"></i>
                                                </a>
                                                <span class="text-secondary">Like</span>
                                            </div>
                                        </div>
                                        <div class="number-like-comment">
                                            <div><b>0</b><span class="ms-2 text-secondary likes-span">Like</span> </div>
                                        </div>
                                    </div>
                                </div>
                                `
                        $('#here').prepend(con);
                        let num = Math.floor(Math.random() * 100000) + 1;
                        $(".news-en").removeClass("news-en").addClass("neww" + num.toString());
                        let str1 = ".neww" + num.toString();
                        $(str1).append(NewPost.ContentOfPost);
                        $(".info-dt").removeClass("info-dt").addClass("info-dt" + num.toString());
                        let str2 = ".info-dt" + num.toString();

                        const date = new Date();
                        const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
                        $(str2).append(formattedDate);

                        $(".info-nm").removeClass("info-nm").addClass("info-nm" + num.toString());
                        let str3 = ".info-nm" + num.toString();
                        $(str3).append(NewPost.UserName);
                    });

                    // new like subscribtion
                    proxy.on("NewLikeAdded", function (uid, pid, clr) {
                        var icon = $("a[data-user-id='" + uid + "'][data-item-id='" + pid + "']").find("i.fa-thumbs-up");
                        icon.addClass("text-" + clr);
                        location.reload();
                    });
                });

                // call server method
                function funlike(uid,pid, flag) {
                    proxy.invoke("Addlike", uid, pid, flag);
                };
            </script>
        }
    </div>
</div>
